#!/bin/bash
#
# submit MOABvESMF profiling jobs from 16-4096 procs
#

# escape characters in datadir are required for sed later on
DATADIR=$PWD"/data/"
GRID1=$DATADIR"ll1280x1280_grid.esmf.nc"
GRID2=$DATADIR"tx0.1v2_nomask.esmf.nc"
#GRID1=$DATADIR"ll10x10_grid.esmf.nc"
#GRID2=$DATADIR"ll10x10_grid.esmf.nc"

# create rundir
RUNDIR=$(python run_id.py 2>&1)
mkdir $RUNDIR
cd $RUNDIR

#bench_procs=(36 72 144 288 576 1152 2304 4608)
bench_procs=(4572)

for pnum in "${bench_procs[@]}"
do
  cd $RUNDIR
  mkdir $pnum
  nnum=$(( $pnum/36 ))
  sed "s&%np%&$pnum&g; s&%nn%&$nnum&g; s&%grid1%&$GRID1&g; s&%grid2%&$GRID2&g" ../../MOAB_eval_run_pbs > $pnum/MOAB_eval_run_pbs
  cp ../../MOAB_eval "$pnum"
  cd "$pnum"
  qsub MOAB_eval_run_pbs
done

# cd $RUNDIR
# for pnum in "${bench_procs[@]}"
# do
#   python ../../collect_timing_reports.py "$pnum"
#   python ../../collect_memory_reports.py "$pnum"
# done
